<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RPG 2D Retro 2008 - P2P, Armas, Editor</title>
    <style>
        /* Estilo retro pixelado */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            box-sizing: border-box;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        body {
            margin: 0;
            min-height: 100vh;
            background: #2a1e0f; /* marr√≥n oscuro como madera */
            font-family: 'Press Start 2P', cursive;
            color: #f0e6d2;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #gameWrapper {
            position: relative;
            width: fit-content;
            border: 8px solid #8b5a2b;
            box-shadow: 0 0 0 4px #4a2c1a, 0 10px 20px rgba(0,0,0,0.5);
            background: #4a2c1a;
        }

        canvas {
            display: block;
            border: 4px solid #c49a6c;
            background: #2e1b0e;
            cursor: crosshair;
            width: 800px;
            height: 800px;
        }

        /* Men√∫ principal superpuesto */
        #mainMenu {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            border: 4px solid #c49a6c;
        }

        #mainMenu h1 {
            font-size: 36px;
            color: #ffd966;
            text-shadow: 4px 4px 0 #b45f06, 6px 6px 0 #000;
            margin-bottom: 40px;
            text-align: center;
            line-height: 1.5;
        }

        .menuBtn {
            font-family: 'Press Start 2P', cursive;
            font-size: 20px;
            padding: 15px 30px;
            margin: 10px;
            width: 250px;
            background: #8b5a2b;
            border: 4px solid #c49a6c;
            color: #ffd966;
            text-shadow: 2px 2px 0 #5a3e1b;
            cursor: pointer;
            box-shadow: 0 6px 0 #4a2c1a;
            transition: all 0.1s ease;
        }

        .menuBtn:hover {
            background: #b87c4b;
            transform: translateY(2px);
            box-shadow: 0 4px 0 #4a2c1a;
        }

        .menuBtn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #4a2c1a;
        }

        /* Panel lateral con estilo retro */
        #sidePanel {
            background: #2e1b0e;
            border: 4px solid #c49a6c;
            padding: 20px;
            width: 320px;
            margin-left: 20px;
            box-shadow: 0 0 0 4px #8b5a2b;
        }

        #sidePanel h2, #sidePanel h3 {
            color: #ffd966;
            text-shadow: 2px 2px 0 #8b5a2b;
            border-bottom: 4px solid #c49a6c;
            padding-bottom: 5px;
            margin-top: 0;
        }

        .panelSection {
            background: #4a2c1a;
            padding: 15px;
            margin-bottom: 20px;
            border: 2px solid #c49a6c;
        }

        label {
            display: block;
            margin: 10px 0 5px;
            font-size: 12px;
            color: #f0e6d2;
        }

        input, select {
            font-family: 'Press Start 2P', cursive;
            background: #1e130a;
            border: 2px solid #c49a6c;
            color: #ffd966;
            padding: 8px;
            width: 100%;
            font-size: 12px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffd966;
        }

        .btn {
            font-family: 'Press Start 2P', cursive;
            background: #8b5a2b;
            border: 2px solid #c49a6c;
            color: #ffd966;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            margin: 5px 0;
            width: 100%;
            text-shadow: 1px 1px 0 #5a3e1b;
            box-shadow: 0 4px 0 #4a2c1a;
            transition: 0.1s;
        }

        .btn:hover {
            background: #b87c4b;
            transform: translateY(2px);
            box-shadow: 0 2px 0 #4a2c1a;
        }

        .btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .inventoryList {
            list-style: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            background: #1e130a;
            border: 2px solid #c49a6c;
            margin: 10px 0;
        }

        .inventoryList li {
            padding: 8px;
            border-bottom: 1px solid #c49a6c;
            color: #f0e6d2;
            font-size: 10px;
            line-height: 1.5;
        }

        .inventoryList li:last-child {
            border-bottom: none;
        }

        #status {
            font-size: 10px;
            color: #aaf0e9;
            background: #1e130a;
            padding: 8px;
            border: 2px solid #c49a6c;
        }

        .peerSection {
            margin-top: 20px;
        }

        /* Estilo para el creador de armas */
        .weaponCreator {
            background: #3e2a15;
            padding: 10px;
            border: 2px solid #c49a6c;
            margin-bottom: 20px;
        }

        .weaponCreator input, .weaponCreator select {
            margin-bottom: 5px;
        }
    </style>
    <!-- Incluimos PeerJS -->
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div id="gameWrapper">
        <canvas id="gameCanvas" width="800" height="800"></canvas>
        <!-- Men√∫ principal -->
        <div id="mainMenu">
            <h1>üåü PIXEL RPG 2008 üåü</h1>
            <button class="menuBtn" id="playBtn">‚ñ∂ JUGAR</button>
            <button class="menuBtn" id="optionsBtn">‚öô OPCIONES</button>
            <button class="menuBtn" id="exitBtn">üö™ SALIR</button>
        </div>
    </div>

    <div id="sidePanel">
        <h2>üë§ AVENTURERO</h2>
        <div class="panelSection">
            <label>NOMBRE:</label>
            <input type="text" id="nameInput" value="H√©roe" maxlength="20">
            <label>üéÆ TAMA√ëO MAPA (N x N)</label>
            <input type="range" id="mapSizeSlider" min="5" max="100" value="15" step="1">
            <span id="mapSizeValue" style="display:block; text-align:center; margin:5px 0;">15</span>
            <button class="btn" id="resizeBtn">üîÑ REDIMENSIONAR</button>
            <button class="btn" id="editorBtn">‚úèÔ∏è EDITOR: OFF</button>
        </div>

        <h3>‚öîÔ∏è CREADOR DE ARMAS</h3>
        <div class="weaponCreator">
            <label>TIPO:</label>
            <select id="weaponType">
                <option value="üó°Ô∏è Espada">üó°Ô∏è Espada</option>
                <option value="üèπ Arco">üèπ Arco</option>
                <option value="üîÆ Varita">üîÆ Varita</option>
            </select>
            <label>NOMBRE:</label>
            <input type="text" id="weaponName" value="Filo Oscuro" maxlength="15">
            <label>DA√ëO (1-99):</label>
            <input type="number" id="weaponDamage" min="1" max="99" value="10">
            <button class="btn" id="createWeaponBtn">üõ†Ô∏è CREAR Y A√ëADIR</button>
        </div>

        <h3>üéí INVENTARIO</h3>
        <ul class="inventoryList" id="inventoryList">
            <li>VAC√çO</li>
        </ul>

        <div class="peerSection">
            <h3>üåê MULTIJUGADOR P2P</h3>
            <button class="btn" id="startPeerBtn">üü¢ INICIAR PEER</button>
            <div style="margin:10px 0; font-size:10px; word-break:break-all;">ID: <span id="peerIdDisplay">-</span></div>
            <input type="text" id="peerConnectInput" placeholder="ID DESTINO">
            <button class="btn" id="connectBtn">üîó CONECTAR</button>
            <div id="status">DESCONECTADO</div>
        </div>
    </div>

    <script>
        // ---------- Configuraci√≥n ----------
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let MAP_SIZE = 15;
        let TILE_SIZE = 800 / MAP_SIZE;

        // Matriz del mapa
        let map = [];
        // Objetos (items) en el mapa: cada objeto tiene {x, y, type}
        let items = [];
        const ITEM_TYPES = ['‚òÖ']; // por ahora solo estrellas (monedas)

        // Inventario local (incluye armas)
        let inventory = [];

        // Jugador local
        let player = {
            x: 7,
            y: 7,
            name: "H√©roe",
            color: '#e94560'
        };

        // Jugador remoto
        let remotePlayer = {
            x: 0,
            y: 0,
            name: "Remoto",
            color: '#4a90e2',
            connected: false
        };

        // Editor
        let editorMode = false;

        // Elementos DOM
        const nameInput = document.getElementById('nameInput');
        const editorBtn = document.getElementById('editorBtn');
        const mapSizeSlider = document.getElementById('mapSizeSlider');
        const mapSizeValue = document.getElementById('mapSizeValue');
        const resizeBtn = document.getElementById('resizeBtn');
        const inventoryList = document.getElementById('inventoryList');
        const peerIdDisplay = document.getElementById('peerIdDisplay');
        const statusDiv = document.getElementById('status');
        const startPeerBtn = document.getElementById('startPeerBtn');
        const connectBtn = document.getElementById('connectBtn');
        const peerConnectInput = document.getElementById('peerConnectInput');
        // Armas
        const weaponType = document.getElementById('weaponType');
        const weaponName = document.getElementById('weaponName');
        const weaponDamage = document.getElementById('weaponDamage');
        const createWeaponBtn = document.getElementById('createWeaponBtn');
        // Men√∫
        const mainMenu = document.getElementById('mainMenu');
        const playBtn = document.getElementById('playBtn');
        const optionsBtn = document.getElementById('optionsBtn');
        const exitBtn = document.getElementById('exitBtn');

        // ---------- PeerJS ----------
        let peer = null;
        let conn = null;
        let myPeerId = null;

        function initPeer() {
            if (peer) peer.destroy();
            peer = new Peer();
            peer.on('open', (id) => {
                myPeerId = id;
                peerIdDisplay.textContent = id;
                statusDiv.textContent = 'PEER ACTIVO, ESPERANDO...';
            });
            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection(conn);
            });
            peer.on('error', (err) => {
                console.error(err);
                statusDiv.textContent = 'ERROR: ' + err.type;
            });
        }

        function setupConnection(connection) {
            conn = connection;
            statusDiv.textContent = 'CONECTADO A: ' + connection.peer;
            connection.on('data', (data) => handlePeerData(data));
            connection.on('close', () => {
                statusDiv.textContent = 'CONEXI√ìN CERRADA';
                remotePlayer.connected = false;
                draw();
            });
            sendFullState();
        }

        function sendFullState() {
            if (conn && conn.open) {
                conn.send({
                    type: 'fullState',
                    map: map,
                    items: items,
                    player: { x: player.x, y: player.y, name: player.name }
                });
            }
        }

        function handlePeerData(data) {
            switch (data.type) {
                case 'fullState':
                    if (data.map) map = data.map;
                    if (data.items) items = data.items;
                    if (data.player) {
                        remotePlayer.x = data.player.x;
                        remotePlayer.y = data.player.y;
                        remotePlayer.name = data.player.name;
                        remotePlayer.connected = true;
                    }
                    draw();
                    break;
                case 'move':
                    remotePlayer.x = data.x;
                    remotePlayer.y = data.y;
                    remotePlayer.name = data.name;
                    remotePlayer.connected = true;
                    draw();
                    break;
                case 'mapEdit':
                    if (data.row !== undefined && data.col !== undefined) {
                        map[data.row][data.col] = data.value;
                        draw();
                    }
                    break;
                case 'itemPickup':
                    if (data.itemIndex !== undefined) {
                        items.splice(data.itemIndex, 1);
                        draw();
                    }
                    break;
            }
        }

        function sendMove() {
            if (conn && conn.open) {
                conn.send({
                    type: 'move',
                    x: player.x,
                    y: player.y,
                    name: player.name
                });
            }
        }

        function sendMapEdit(row, col, value) {
            if (conn && conn.open) {
                conn.send({
                    type: 'mapEdit',
                    row: row,
                    col: col,
                    value: value
                });
            }
        }

        function sendItemPickup(index) {
            if (conn && conn.open) {
                conn.send({
                    type: 'itemPickup',
                    itemIndex: index
                });
            }
        }

        // ---------- Funciones del mapa ----------
        function initMap(size) {
            MAP_SIZE = size;
            TILE_SIZE = 800 / MAP_SIZE;

            map = [];
            for (let i = 0; i < MAP_SIZE; i++) {
                map[i] = [];
                for (let j = 0; j < MAP_SIZE; j++) {
                    map[i][j] = 0;
                }
            }
            // Bordes pared
            for (let i = 0; i < MAP_SIZE; i++) {
                map[0][i] = 1;
                map[MAP_SIZE-1][i] = 1;
                map[i][0] = 1;
                map[i][MAP_SIZE-1] = 1;
            }
            // Paredes aleatorias internas (10%)
            for (let i = 2; i < MAP_SIZE-2; i++) {
                for (let j = 2; j < MAP_SIZE-2; j++) {
                    if (Math.random() < 0.1) {
                        map[i][j] = 1;
                    }
                }
            }
            // Posici√≥n inicial jugador
            player.x = Math.floor(MAP_SIZE/2);
            player.y = Math.floor(MAP_SIZE/2);
            map[player.y][player.x] = 0;

            // Generar items (estrellas) en 5% de celdas suelo
            items = [];
            for (let i = 1; i < MAP_SIZE-1; i++) {
                for (let j = 1; j < MAP_SIZE-1; j++) {
                    if (map[i][j] === 0 && Math.random() < 0.05) {
                        items.push({ x: j, y: i, type: '‚òÖ' });
                    }
                }
            }
        }

        function resizeMap() {
            let newSize = parseInt(mapSizeSlider.value);
            initMap(newSize);
            inventory = []; // opcional: reiniciar inventario
            updateInventoryDisplay();
            if (conn && conn.open) sendFullState();
            draw();
        }

        // ---------- Dibujado ----------
        function draw() {
            ctx.clearRect(0, 0, 800, 800);

            // Tiles
            for (let row = 0; row < MAP_SIZE; row++) {
                for (let col = 0; col < MAP_SIZE; col++) {
                    let x = col * TILE_SIZE;
                    let y = row * TILE_SIZE;
                    ctx.fillStyle = map[row][col] === 0 ? '#4caf50' : '#9e9e9e';
                    ctx.fillRect(x, y, TILE_SIZE - 1, TILE_SIZE - 1);
                    ctx.strokeStyle = '#555';
                    ctx.strokeRect(x, y, TILE_SIZE, TILE_SIZE);
                }
            }

            // Items (estrellas)
            ctx.font = `${TILE_SIZE * 0.6}px 'Press Start 2P', monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'gold';
            items.forEach(item => {
                let x = item.x * TILE_SIZE + TILE_SIZE/2;
                let y = item.y * TILE_SIZE + TILE_SIZE/2;
                ctx.fillText(item.type, x, y);
            });

            // Jugador remoto
            if (remotePlayer.connected) {
                let rx = remotePlayer.x * TILE_SIZE + TILE_SIZE/2;
                let ry = remotePlayer.y * TILE_SIZE + TILE_SIZE/2;
                ctx.beginPath();
                ctx.arc(rx, ry, TILE_SIZE/3, 0, 2*Math.PI);
                ctx.fillStyle = remotePlayer.color;
                ctx.fill();
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                ctx.font = `bold ${TILE_SIZE/4}px 'Press Start 2P', monospace`;
                ctx.fillStyle = 'white';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.textAlign = 'center';
                ctx.strokeText(remotePlayer.name, rx, ry - TILE_SIZE/2 - 5);
                ctx.fillText(remotePlayer.name, rx, ry - TILE_SIZE/2 - 5);
            }

            // Jugador local
            let px = player.x * TILE_SIZE + TILE_SIZE/2;
            let py = player.y * TILE_SIZE + TILE_SIZE/2;
            ctx.beginPath();
            ctx.arc(px, py, TILE_SIZE/3, 0, 2*Math.PI);
            ctx.fillStyle = player.color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.font = `bold ${TILE_SIZE/4}px 'Press Start 2P', monospace`;
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'black';
            ctx.lineWidth = 3;
            ctx.textAlign = 'center';
            ctx.strokeText(player.name, px, py - TILE_SIZE/2 - 5);
            ctx.fillText(player.name, px, py - TILE_SIZE/2 - 5);
        }

        // Actualizar lista de inventario
        function updateInventoryDisplay() {
            if (inventory.length === 0) {
                inventoryList.innerHTML = '<li>VAC√çO</li>';
            } else {
                inventoryList.innerHTML = inventory.map((item, i) => {
                    if (typeof item === 'string') return `<li>${item}</li>`;
                    else return `<li>${item.icon} ${item.name} (da√±o ${item.damage})</li>`;
                }).join('');
            }
        }

        // Recoger item si el jugador est√° sobre uno
        function pickupItemAt(x, y) {
            for (let i = items.length - 1; i >= 0; i--) {
                if (items[i].x === x && items[i].y === y) {
                    let item = items[i].type;
                    inventory.push(item); // item es '‚òÖ'
                    items.splice(i, 1);
                    updateInventoryDisplay();
                    sendItemPickup(i);
                    draw();
                    break;
                }
            }
        }

        // Movimiento
        function tryMove(dx, dy) {
            let newX = player.x + dx;
            let newY = player.y + dy;
            if (newX < 0 || newX >= MAP_SIZE || newY < 0 || newY >= MAP_SIZE) return false;
            if (map[newY][newX] === 1) return false;

            player.x = newX;
            player.y = newY;
            pickupItemAt(newX, newY);
            sendMove();
            draw();
            return true;
        }

        // ---------- Creador de armas ----------
        function createWeapon() {
            let type = weaponType.value;  // ej: "üó°Ô∏è Espada"
            let name = weaponName.value.trim() || "Arma";
            let damage = parseInt(weaponDamage.value) || 1;
            // Extraer solo el emoji del tipo
            let icon = type.split(' ')[0];
            let weapon = {
                icon: icon,
                name: name,
                damage: damage,
                type: type
            };
            inventory.push(weapon);
            updateInventoryDisplay();
        }

        // ---------- Eventos teclado ----------
        document.addEventListener('keydown', (e) => {
            if (editorMode) return;
            switch(e.key) {
                case 'w': tryMove(0, -1); break;
                case 's': tryMove(0, 1); break;
                case 'a': tryMove(-1, 0); break;
                case 'd': tryMove(1, 0); break;
            }
        });

        // Editor: clics en canvas
        canvas.addEventListener('mousedown', (e) => {
            if (!editorMode) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            const col = Math.floor(mouseX / TILE_SIZE);
            const row = Math.floor(mouseY / TILE_SIZE);
            if (row >= 0 && row < MAP_SIZE && col >= 0 && col < MAP_SIZE) {
                let value = (e.button === 0) ? 1 : 0;
                map[row][col] = value;
                sendMapEdit(row, col, value);
                draw();
            }
        });
        canvas.addEventListener('contextmenu', e => e.preventDefault());

        // Botones de interfaz
        editorBtn.addEventListener('click', () => {
            editorMode = !editorMode;
            editorBtn.textContent = editorMode ? "‚úèÔ∏è EDITOR: ON" : "‚úèÔ∏è EDITOR: OFF";
        });

        nameInput.addEventListener('input', (e) => {
            player.name = e.target.value || "H√©roe";
            draw();
        });

        mapSizeSlider.addEventListener('input', (e) => {
            mapSizeValue.textContent = e.target.value;
        });
        resizeBtn.addEventListener('click', resizeMap);

        // PeerJS
        startPeerBtn.addEventListener('click', initPeer);
        connectBtn.addEventListener('click', () => {
            let remoteId = peerConnectInput.value.trim();
            if (!remoteId || !peer) {
                alert('Primero inicia Peer');
                return;
            }
            conn = peer.connect(remoteId);
            conn.on('open', () => setupConnection(conn));
            conn.on('error', (err) => statusDiv.textContent = 'ERROR: ' + err);
        });

        // Crear arma
        createWeaponBtn.addEventListener('click', createWeapon);

        // Men√∫ principal
        playBtn.addEventListener('click', () => {
            mainMenu.style.display = 'none';
        });
        optionsBtn.addEventListener('click', () => {
            alert('OPCIONES: Usa el panel lateral para ajustes.');
        });
        exitBtn.addEventListener('click', () => {
            if (confirm('¬øSeguro que quieres salir?')) {
                window.close(); // Puede no funcionar en todos los navegadores
            }
        });

        // Inicializar
        initMap(15);
        draw();
        updateInventoryDisplay();
    </script>
</body>
</html>
