<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Multiplayer 2.5D Battle</title>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; }
        #ui { position: absolute; top: 10px; left: 10px; color: white; font-family: sans-serif; }
    </style>
</head>
<body>
    <div id="ui">
        <p>Tu ID: <span id="my-id">...</span></p>
        <input type="text" id="peer-id" placeholder="ID del amigo">
        <button onclick="connectToPeer()">Conectar</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>

    <script>
        // --- CONFIGURACIÓN 3D ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Luz y Suelo
        const light = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(light);
        const grid = new THREE.GridHelper(100, 50);
        scene.add(grid);

        // --- PERSONAJE (SPRITE 2D) ---
        function createPlayerSprite(color = 0x00ff00) {
            const map = new THREE.TextureLoader().load('https://i.imgur.com/8N76Z9t.png'); // Usa un sprite real aquí
            const material = new THREE.SpriteMaterial({ map: map, color: color });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(1, 2, 1); // Personaje alto
            sprite.position.y = 1;
            return sprite;
        }

        const player = createPlayerSprite(0x00ff00);
        scene.add(player);
        
        // Cámara estilo Fortnite (atrás y arriba)
        camera.position.set(0, 5, 10);
        player.add(camera); // La cámara sigue al jugador

        // --- MULTIJUGADOR P2P ---
        const peer = new Peer();
        let conn;
        const otherPlayers = {};

        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
        });

        // Al recibir una conexión
        peer.on('connection', c => {
            setupConnection(c);
        });

        function connectToPeer() {
            const peerId = document.getElementById('peer-id').value;
            const c = peer.connect(peerId);
            setupConnection(c);
        }

        function setupConnection(c) {
            conn = c;
            conn.on('data', data => {
                if (!otherPlayers[conn.peer]) {
                    otherPlayers[conn.peer] = createPlayerSprite(0xff0000);
                    scene.add(otherPlayers[conn.peer]);
                }
                // Actualizar posición del otro jugador
                otherPlayers[conn.peer].position.set(data.x, data.y, data.z);
            });
        }

        // --- MOVIMIENTO ---
        const keys = {};
        window.onkeydown = e => keys[e.key] = true;
        window.onkeyup = e => keys[e.key] = false;

        function update() {
            const speed = 0.1;
            if (keys['w']) player.position.z -= speed;
            if (keys['s']) player.position.z += speed;
            if (keys['a']) player.position.x -= speed;
            if (keys['d']) player.position.x += speed;

            // Enviar posición por P2P
            if (conn && conn.open) {
                conn.send({ x: player.position.x, y: player.position.y, z: player.position.z });
            }

            camera.lookAt(player.position);
            renderer.render(scene, camera);
            requestAnimationFrame(update);
        }

        update();
    </script>
</body>
</html>
