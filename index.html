<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>RTS con enemigos y construcci√≥n ¬∑ Age of Grid</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #1a2a1a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #gameContainer {
            background: #2a3a2a;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.7);
        }
        canvas {
            display: block;
            margin: 0 auto;
            border: 3px solid #6b4e3a;
            border-radius: 8px;
            cursor: crosshair;
        }
        #infoPanel {
            margin-top: 12px;
            color: #e0d8b0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #3b4a3b;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #8b7a5a;
            flex-wrap: wrap;
        }
        #resources {
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #2a3a2a;
            min-width: 180px;
        }
        #selectedInfo {
            background: #4a5a4a;
            padding: 4px 16px;
            border-radius: 30px;
            border: 1px solid #b0a880;
            min-width: 200px;
            text-align: center;
        }
        .botones {
            display: flex;
            gap: 8px;
        }
        button {
            background: #6b8c5c;
            border: none;
            color: white;
            font-weight: bold;
            padding: 6px 15px;
            border-radius: 30px;
            cursor: pointer;
            border-bottom: 3px solid #3a5a3a;
            transition: 0.1s ease;
            font-size: 1rem;
        }
        button:hover {
            background: #7b9c6c;
            border-bottom-width: 1px;
            transform: translateY(2px);
        }
        button:active {
            transform: translateY(4px);
            border-bottom-width: 0;
        }
        button:disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        #construirBtn {
            background: #b88a3a;
            border-bottom-color: #6b4e1a;
        }
    </style>
</head>
<body>
<div id="gameContainer">
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="infoPanel">
        <div id="resources">üå≤ 200  üçñ 100  ‚öîÔ∏è 0</div>
        <div id="selectedInfo">üè† Ninguno</div>
        <div class="botones">
            <button id="buildBarracksBtn" title="Construir cuartel (150üå≤)">üèõÔ∏è Cuartel</button>
            <button id="trainUnitBtn" style="display:none;">‚öîÔ∏è Entrenar</button>
        </div>
    </div>
</div>

<script>
    // --------------------------------------------------------------
    // CONSTANTES
    // --------------------------------------------------------------
    const CELDA = 25;                // p√≠xeles por celda (m√°s peque√±a para mapa grande)
    const COLUMNAS = 32;             // 800/25
    const FILAS = 24;                // 600/25

    // Tipos de terreno
    const TERRENO = {
        TIERRA: 0,
        AGUA: 1,
        BOSQUE: 2,
        MONTA√ëA: 3
    };

    const COLOR_TERRENO = [
        "#6b8e4c", // tierra
        "#3a6ea5", // agua
        "#2d5a2d", // bosque (√°rboles)
        "#7a6a5a"  // monta√±a
    ];

    // --------------------------------------------------------------
    // RECURSOS DEL JUGADOR
    // --------------------------------------------------------------
    let recursos = { madera: 200, comida: 100 };

    // --------------------------------------------------------------
    // MAPA (matriz de celdas)
    // --------------------------------------------------------------
    let mapa = [];
    function generarMapa() {
        for (let f = 0; f < FILAS; f++) {
            let fila = [];
            for (let c = 0; c < COLUMNAS; c++) {
                let r = Math.random();
                let tipo;
                if (r < 0.55) tipo = TERRENO.TIERRA;
                else if (r < 0.7) tipo = TERRENO.BOSQUE;
                else if (r < 0.85) tipo = TERRENO.AGUA;
                else tipo = TERRENO.MONTA√ëA;

                fila.push({
                    tipo: tipo,
                    recurso: (tipo === TERRENO.BOSQUE) ? { tipo: "madera", cantidad: 100 } : null,
                    edificio: null,    // edificio actual (si est√° construido)
                    construyendo: null, // { tipo, progreso, tiempoTotal, aldeanoAsignado } para edificio en construcci√≥n
                    unidad: null
                });
            }
            mapa.push(fila);
        }
    }
    generarMapa();

    // Asegurar zona inicial del jugador (centro del mapa)
    mapa[12][16].tipo = TERRENO.TIERRA; // centro aproximado
    mapa[12][16].recurso = null;

    // Crear centro del jugador (ya construido)
    mapa[12][16].edificio = {
        tipo: "centro",
        salud: 500,
        produccion: [], // cola de entrenamiento
        equipo: "jugador"
    };

    // Crear centro enemigo en esquina superior izquierda
    mapa[2][2].tipo = TERRENO.TIERRA;
    mapa[2][2].edificio = {
        tipo: "centro",
        salud: 500,
        produccion: [],
        equipo: "enemigo"
    };

    // --------------------------------------------------------------
    // CLASES
    // --------------------------------------------------------------
    class Unidad {
        constructor(x, y, tipo, hp, ataque, velocidad, equipo) {
            this.x = x;             // float celda
            this.y = y;
            this.tipo = tipo;       // "aldeano", "soldado"
            this.hp = hp;
            this.maxHp = hp;
            this.ataque = ataque;
            this.velocidad = velocidad; // celdas/segundo
            this.equipo = equipo;    // "jugador" o "enemigo"
            this.destino = null;
            this.estado = "idle";    // idle, moviendo, atacando, recolectando, construyendo
            this.objetivoAtaque = null; // unidad o edificio enemigo
            this.objetivoRecurso = null;
            this.carga = 0;
            this.capacidadCarga = 10;
            this.tiempoAtaque = 0;   // cooldown
            this.rangoAtaque = (tipo === "soldado") ? 1.5 : 1; // cuerpo a cuerpo
        }

        irA(destX, destY) {
            if (destX < 0 || destX >= COLUMNAS || destY < 0 || destY >= FILAS) return false;
            this.destino = { x: destX, y: destY };
            this.estado = "moviendo";
            this.objetivoAtaque = null;
            return true;
        }

        actualizarMovimiento(dt) {
            if (this.estado !== "moviendo" || !this.destino) return;

            let dx = this.destino.x - this.x;
            let dy = this.destino.y - this.y;
            let dist = Math.hypot(dx, dy);

            if (dist < 0.1) {
                this.x = this.destino.x;
                this.y = this.destino.y;
                this.destino = null;
                this.estado = "idle";
                return;
            }

            let step = this.velocidad * dt;
            if (step > dist) step = dist;
            this.x += (dx / dist) * step;
            this.y += (dy / dist) * step;
        }

        atacar(objetivo) {
            if (!objetivo) return;
            let dx = objetivo.x - this.x;
            let dy = objetivo.y - this.y;
            let dist = Math.hypot(dx, dy);
            if (dist <= this.rangoAtaque) {
                objetivo.hp -= this.ataque;
                if (objetivo.hp <= 0) {
                    objetivo.morir();
                    this.estado = "idle";
                    this.objetivoAtaque = null;
                }
            } else {
                // Acercarse
                this.irA(objetivo.x, objetivo.y);
                this.objetivoAtaque = objetivo;
            }
        }

        morir() {
            // Eliminar del mapa y de la lista correspondiente
            let lista = (this.equipo === "jugador") ? unidadesJugador : unidadesEnemigo;
            let idx = lista.indexOf(this);
            if (idx !== -1) lista.splice(idx, 1);
            // Limpiar referencia en mapa
            for (let f = 0; f < FILAS; f++) {
                for (let c = 0; c < COLUMNAS; c++) {
                    if (mapa[f][c].unidad === this) mapa[f][c].unidad = null;
                }
            }
        }
    }

    // --------------------------------------------------------------
    // LISTAS DE UNIDADES
    // --------------------------------------------------------------
    let unidadesJugador = [];
    let unidadesEnemigo = [];

    // Crear aldeano inicial cerca del centro
    unidadesJugador.push(new Unidad(16, 12, "aldeano", 25, 3, 4.0, "jugador"));

    // Crear soldado enemigo inicial cerca de su centro
    unidadesEnemigo.push(new Unidad(3, 3, "soldado", 40, 8, 3.0, "enemigo"));

    // --------------------------------------------------------------
    // VARIABLES DE SELECCI√ìN
    // --------------------------------------------------------------
    let unidadSeleccionada = null;
    let edificioSeleccionado = null; // { celda, tipo, equipo }
    let modoConstruccion = null; // { tipo, costo } o null

    // --------------------------------------------------------------
    // CANVAS Y CONTEXTO
    // --------------------------------------------------------------
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --------------------------------------------------------------
    // INTERFAZ
    // --------------------------------------------------------------
    const resourcesSpan = document.getElementById('resources');
    const selectedInfoSpan = document.getElementById('selectedInfo');
    const buildBarracksBtn = document.getElementById('buildBarracksBtn');
    const trainUnitBtn = document.getElementById('trainUnitBtn');

    function actualizarUI() {
        resourcesSpan.innerHTML = `üå≤ ${recursos.madera}  üçñ ${recursos.comida} ‚öîÔ∏è ${unidadesJugador.length}`;

        if (edificioSeleccionado) {
            let tipo = edificioSeleccionado.tipo;
            selectedInfoSpan.innerHTML = `üè† ${tipo} (${Math.round(edificioSeleccionado.celda.x)},${Math.round(edificioSeleccionado.celda.y)})`;
            if (tipo === "centro" && edificioSeleccionado.equipo === "jugador") {
                trainUnitBtn.style.display = "inline-block";
                trainUnitBtn.innerText = "üë®‚Äçüåæ Aldeano (50üå≤)";
                trainUnitBtn.onclick = () => entrenarUnidad("aldeano");
            } else if (tipo === "cuartel" && edificioSeleccionado.equipo === "jugador") {
                trainUnitBtn.style.display = "inline-block";
                trainUnitBtn.innerText = "‚öîÔ∏è Soldado (50üå≤ 30üçñ)";
                trainUnitBtn.onclick = () => entrenarUnidad("soldado");
            } else {
                trainUnitBtn.style.display = "none";
            }
        } else if (unidadSeleccionada) {
            selectedInfoSpan.innerHTML = `üë§ ${unidadSeleccionada.tipo} (${Math.round(unidadSeleccionada.hp)}/${unidadSeleccionada.maxHp})`;
            trainUnitBtn.style.display = "none";
        } else {
            selectedInfoSpan.innerHTML = `üè† Ninguno`;
            trainUnitBtn.style.display = "none";
        }
    }

    // --------------------------------------------------------------
    // CONSTRUCCI√ìN DE EDIFICIOS
    // --------------------------------------------------------------
    buildBarracksBtn.addEventListener('click', () => {
        if (recursos.madera >= 150) {
            modoConstruccion = { tipo: "cuartel", costo: 150 };
            selectedInfoSpan.innerHTML = "üèóÔ∏è Coloca el cuartel en tierra";
        } else {
            alert("No tienes suficiente madera (150)");
        }
    });

    function iniciarConstruccion(x, y) {
        if (!modoConstruccion) return false;
        let celda = mapa[y][x];
        // Verificar terreno libre y sin edificio
        if (celda.tipo !== TERRENO.TIERRA || celda.edificio || celda.construyendo) return false;

        // Descontar recursos
        recursos.madera -= modoConstruccion.costo;

        // Crear construcci√≥n
        celda.construyendo = {
            tipo: modoConstruccion.tipo,
            progreso: 0,
            tiempoTotal: 3.0, // 3 segundos
            equipo: "jugador"
        };

        modoConstruccion = null;
        return true;
    }

    // Actualizar construcciones cada frame
    function actualizarConstrucciones(dt) {
        for (let f = 0; f < FILAS; f++) {
            for (let c = 0; c < COLUMNAS; c++) {
                let celda = mapa[f][c];
                if (celda.construyendo) {
                    celda.construyendo.progreso += dt;
                    if (celda.construyendo.progreso >= celda.construyendo.tiempoTotal) {
                        // Construcci√≥n completada
                        celda.edificio = {
                            tipo: celda.construyendo.tipo,
                            salud: 200,
                            equipo: celda.construyendo.equipo,
                            produccion: []
                        };
                        celda.construyendo = null;
                    }
                }
            }
        }
    }

    // --------------------------------------------------------------
    // ENTRENAMIENTO DE UNIDADES
    // --------------------------------------------------------------
    function entrenarUnidad(tipo) {
        if (!edificioSeleccionado) return;
        let celda = edificioSeleccionado.celda;
        let edificio = celda.edificio;
        if (!edificio || edificio.equipo !== "jugador") return;

        if (tipo === "aldeano" && recursos.madera >= 50) {
            recursos.madera -= 50;
            // Simular tiempo de entrenamiento (3s) con cola
            edificio.produccion.push({ tipo: "aldeano", tiempo: 0, total: 3 });
        } else if (tipo === "soldado" && recursos.madera >= 50 && recursos.comida >= 30) {
            recursos.madera -= 50;
            recursos.comida -= 30;
            edificio.produccion.push({ tipo: "soldado", tiempo: 0, total: 4 });
        }
    }

    function actualizarEntrenamiento(dt) {
        // Procesar colas de todos los edificios
        for (let f = 0; f < FILAS; f++) {
            for (let c = 0; c < COLUMNAS; c++) {
                let edificio = mapa[f][c].edificio;
                if (edificio && edificio.produccion && edificio.produccion.length > 0) {
                    let primero = edificio.produccion[0];
                    primero.tiempo += dt;
                    if (primero.tiempo >= primero.total) {
                        // Crear unidad
                        let nuevaUnidad = new Unidad(c, f, primero.tipo,
                            primero.tipo === "aldeano" ? 25 : 40,
                            primero.tipo === "aldeano" ? 3 : 8,
                            primero.tipo === "aldeano" ? 4 : 3,
                            "jugador");
                        unidadesJugador.push(nuevaUnidad);
                        edificio.produccion.shift();
                    }
                }
            }
        }
    }

    // --------------------------------------------------------------
    // IA ENEMIGA
    // --------------------------------------------------------------
    let tiempoUltimoSpawn = 0;
    function actualizarIAEnemiga(dt) {
        // Spawn peri√≥dico de enemigos
        tiempoUltimoSpawn += dt;
        if (tiempoUltimoSpawn > 10) { // cada 10 segundos
            tiempoUltimoSpawn = 0;
            // Buscar centro enemigo
            for (let f = 0; f < FILAS; f++) {
                for (let c = 0; c < COLUMNAS; c++) {
                    let ed = mapa[f][c].edificio;
                    if (ed && ed.equipo === "enemigo" && ed.tipo === "centro") {
                        // Crear soldado enemigo cerca
                        unidadesEnemigo.push(new Unidad(c+1, f+1, "soldado", 40, 8, 3.0, "enemigo"));
                        break;
                    }
                }
            }
        }

        // Comportamiento de unidades enemigas: atacar lo m√°s cercano
        unidadesEnemigo.forEach(enemigo => {
            if (enemigo.estado === "atacando" && enemigo.objetivoAtaque) {
                enemigo.atacar(enemigo.objetivoAtaque);
                return;
            }

            // Buscar objetivo cercano (unidad o edificio del jugador)
            let objetivo = null;
            let distMin = 1000;

            // Buscar unidades jugador
            unidadesJugador.forEach(u => {
                let d = Math.hypot(u.x - enemigo.x, u.y - enemigo.y);
                if (d < distMin) {
                    distMin = d;
                    objetivo = u;
                }
            });

            // Buscar edificios del jugador
            for (let f = 0; f < FILAS; f++) {
                for (let c = 0; c < COLUMNAS; c++) {
                    let ed = mapa[f][c].edificio;
                    if (ed && ed.equipo === "jugador") {
                        let d = Math.hypot(c - enemigo.x, f - enemigo.y);
                        if (d < distMin) {
                            distMin = d;
                            objetivo = { x: c, y: f, hp: ed.salud, edificio: true, celda: {x:c, y:f} };
                        }
                    }
                }
            }

            if (objetivo) {
                enemigo.estado = "atacando";
                enemigo.objetivoAtaque = objetivo;
                if (objetivo.edificio) {
                    // Moverse a la celda del edificio
                    enemigo.irA(objetivo.x, objetivo.y);
                }
            } else {
                // Patrullar aleatoriamente
                if (Math.random() < 0.01) {
                    enemigo.irA(Math.random() * COLUMNAS, Math.random() * FILAS);
                }
            }
        });
    }

    // --------------------------------------------------------------
    // RECOLECCI√ìN PARA ALDEANOS
    // --------------------------------------------------------------
    function actualizarAldeanos(dt) {
        unidadesJugador.forEach(u => {
            if (u.tipo !== "aldeano") return;

            // Si est√° recolectando
            if (u.estado === "recolectando" && u.objetivoRecurso) {
                let celda = mapa[u.objetivoRecurso.y][u.objetivoRecurso.x];
                if (!celda.recurso || celda.recurso.cantidad <= 0) {
                    u.estado = "idle";
                    u.objetivoRecurso = null;
                    return;
                }

                if (!u.recoleccionTimer) u.recoleccionTimer = 0;
                u.recoleccionTimer += dt;
                while (u.recoleccionTimer >= 0.5 && celda.recurso.cantidad > 0 && u.carga < u.capacidadCarga) {
                    u.recoleccionTimer -= 0.5;
                    let recolectado = Math.min(10, celda.recurso.cantidad, u.capacidadCarga - u.carga);
                    celda.recurso.cantidad -= recolectado;
                    u.carga += recolectado;
                }

                if (celda.recurso.cantidad <= 0) {
                    celda.recurso = null;
                    u.estado = "idle";
                    u.objetivoRecurso = null;
                }

                if (u.carga >= u.capacidadCarga) {
                    // Ir al centro a depositar
                    u.irA(16, 12); // centro del jugador
                    u.estado = "moviendo";
                }
            }

            // Si est√° idle y hay recursos cerca, ir a recolectar (simple)
            if (u.estado === "idle") {
                // Buscar √°rbol cercano
                for (let dy = -3; dy <= 3; dy++) {
                    for (let dx = -3; dx <= 3; dx++) {
                        let nx = Math.round(u.x) + dx;
                        let ny = Math.round(u.y) + dy;
                        if (nx >= 0 && nx < COLUMNAS && ny >= 0 && ny < FILAS) {
                            if (mapa[ny][nx].recurso) {
                                u.objetivoRecurso = { x: nx, y: ny };
                                u.irA(nx, ny);
                                return;
                            }
                        }
                    }
                }
            }

            // Depositar al llegar al centro
            if (u.estado === "idle" && Math.hypot(u.x - 16, u.y - 12) < 1.0 && u.carga > 0) {
                recursos.madera += u.carga;
                u.carga = 0;
            }
        });
    }

    // --------------------------------------------------------------
    // COMBATE (ataques entre unidades)
    // --------------------------------------------------------------
    function actualizarCombate(dt) {
        // Ataques de enemigos a unidades jugador
        unidadesEnemigo.forEach(e => {
            if (e.estado === "atacando" && e.objetivoAtaque) {
                e.atacar(e.objetivoAtaque);
            }
        });

        // Ataques de unidades jugador a enemigos (si est√°n en rango)
        unidadesJugador.forEach(u => {
            if (u.tipo === "soldado" && u.estado === "idle") {
                // Buscar enemigo cercano
                let enemigoCercano = null;
                let distMin = 5;
                unidadesEnemigo.forEach(e => {
                    let d = Math.hypot(e.x - u.x, e.y - u.y);
                    if (d < distMin) {
                        distMin = d;
                        enemigoCercano = e;
                    }
                });
                if (enemigoCercano) {
                    u.estado = "atacando";
                    u.objetivoAtaque = enemigoCercano;
                }
            }
            if (u.estado === "atacando" && u.objetivoAtaque) {
                u.atacar(u.objetivoAtaque);
            }
        });

        // Ataques a edificios
        // (simplificado: si un enemigo est√° cerca de un edificio, lo da√±a)
        unidadesEnemigo.forEach(e => {
            for (let f = 0; f < FILAS; f++) {
                for (let c = 0; c < COLUMNAS; c++) {
                    let ed = mapa[f][c].edificio;
                    if (ed && ed.equipo === "jugador") {
                        let d = Math.hypot(c - e.x, f - e.y);
                        if (d < 1.5) {
                            ed.salud -= e.ataque * dt; // da√±o por segundo
                            if (ed.salud <= 0) {
                                mapa[f][c].edificio = null;
                            }
                        }
                    }
                }
            }
        });
    }

    // --------------------------------------------------------------
    // DIBUJADO
    // --------------------------------------------------------------
    function dibujarMapa() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let fila = 0; fila < FILAS; fila++) {
            for (let col = 0; col < COLUMNAS; col++) {
                let celda = mapa[fila][col];
                ctx.fillStyle = COLOR_TERRENO[celda.tipo];
                ctx.fillRect(col * CELDA, fila * CELDA, CELDA-1, CELDA-1);

                // Recursos (√°rboles)
                if (celda.recurso) {
                    ctx.fillStyle = "#3c8c3c";
                    ctx.beginPath();
                    ctx.arc(col * CELDA + CELDA/2, fila * CELDA + CELDA/2, 8, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = "#5a3e1a";
                    ctx.fillRect(col * CELDA + 8, fila * CELDA + 15, 6, 6);
                }

                // Edificio construido
                if (celda.edificio) {
                    ctx.fillStyle = celda.edificio.equipo === "jugador" ? "#a52a2a" : "#8b3a3a";
                    ctx.fillRect(col * CELDA + 2, fila * CELDA + 2, CELDA-6, CELDA-6);
                    // Mostrar salud
                    ctx.fillStyle = "#00ff00";
                    let saludPercent = celda.edificio.salud / 500;
                    ctx.fillRect(col * CELDA + 2, fila * CELDA - 3, (CELDA-6) * saludPercent, 3);
                }

                // Construcci√≥n en progreso
                if (celda.construyendo) {
                    ctx.fillStyle = "#aaaaaa";
                    ctx.fillRect(col * CELDA + 2, fila * CELDA + 2, CELDA-6, CELDA-6);
                    ctx.fillStyle = "#ffff00";
                    let progreso = celda.construyendo.progreso / celda.construyendo.tiempoTotal;
                    ctx.fillRect(col * CELDA + 2, fila * CELDA + CELDA-6, (CELDA-6) * progreso, 4);
                }

                // Resaltar celda si estamos en modo construcci√≥n
                if (modoConstruccion) {
                    ctx.strokeStyle = "#ffd700";
                    ctx.lineWidth = 2;
                    ctx.strokeRect(col * CELDA, fila * CELDA, CELDA, CELDA);
                }
            }
        }

        // Unidades jugador
        unidadesJugador.forEach(u => {
            let x = u.x * CELDA;
            let y = u.y * CELDA;
            ctx.fillStyle = (u.tipo === "aldeano") ? "#f0d880" : "#c04040";
            ctx.beginPath();
            ctx.arc(x + CELDA/2, y + CELDA/2, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 1;
            ctx.stroke();
            if (unidadSeleccionada === u) {
                ctx.strokeStyle = "#ffd700";
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(x + CELDA/2, y + CELDA/2, 14, 0, 2*Math.PI);
                ctx.stroke();
            }
            // Barra de salud
            ctx.fillStyle = "#00ff00";
            ctx.fillRect(x + 2, y - 6, 20 * (u.hp / u.maxHp), 3);
        });

        // Unidades enemigo
        unidadesEnemigo.forEach(u => {
            let x = u.x * CELDA;
            let y = u.y * CELDA;
            ctx.fillStyle = "#a00";
            ctx.beginPath();
            ctx.arc(x + CELDA/2, y + CELDA/2, 10, 0, 2*Math.PI);
            ctx.fill();
            ctx.strokeStyle = "#000";
            ctx.stroke();
        });

        // Rejilla
        ctx.strokeStyle = "#4a6a4a";
        ctx.lineWidth = 0.5;
        for (let i = 0; i <= COLUMNAS; i++) {
            ctx.beginPath();
            ctx.moveTo(i * CELDA, 0);
            ctx.lineTo(i * CELDA, canvas.height);
            ctx.stroke();
        }
        for (let i = 0; i <= FILAS; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * CELDA);
            ctx.lineTo(canvas.width, i * CELDA);
            ctx.stroke();
        }
    }

    // --------------------------------------------------------------
    // LOOP PRINCIPAL
    // --------------------------------------------------------------
    let ultimoTiempo = performance.now() / 1000;
    function gameLoop(now) {
        now /= 1000;
        let dt = Math.min(0.1, now - ultimoTiempo);
        ultimoTiempo = now;

        // Actualizaciones
        actualizarConstrucciones(dt);
        actualizarEntrenamiento(dt);
        actualizarAldeanos(dt);
        actualizarIAEnemiga(dt);
        actualizarCombate(dt);

        // Mover todas las unidades
        [...unidadesJugador, ...unidadesEnemigo].forEach(u => u.actualizarMovimiento(dt));

        // Actualizar ocupaci√≥n en mapa
        for (let f = 0; f < FILAS; f++) {
            for (let c = 0; c < COLUMNAS; c++) {
                mapa[f][c].unidad = null;
            }
        }
        [...unidadesJugador, ...unidadesEnemigo].forEach(u => {
            let cx = Math.round(u.x);
            let cy = Math.round(u.y);
            if (cx >= 0 && cx < COLUMNAS && cy >= 0 && cy < FILAS) {
                mapa[cy][cx].unidad = u;
            }
        });

        dibujarMapa();
        actualizarUI();

        requestAnimationFrame(gameLoop);
    }

    // --------------------------------------------------------------
    // EVENTOS DE RAT√ìN
    // --------------------------------------------------------------
    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        const mouseX = (e.clientX - rect.left) * scaleX;
        const mouseY = (e.clientY - rect.top) * scaleY;
        const col = Math.floor(mouseX / CELDA);
        const fila = Math.floor(mouseY / CELDA);

        if (e.button === 0) { // Izquierdo
            // Si estamos en modo construcci√≥n, colocar edificio
            if (modoConstruccion) {
                iniciarConstruccion(col, fila);
                return;
            }

            // Seleccionar unidad o edificio
            let unidad = [...unidadesJugador, ...unidadesEnemigo].find(u => Math.round(u.x) === col && Math.round(u.y) === col && u.equipo === "jugador");
            if (unidad) {
                unidadSeleccionada = unidad;
                edificioSeleccionado = null;
            } else {
                let celda = mapa[fila][col];
                if (celda.edificio && celda.edificio.equipo === "jugador") {
                    edificioSeleccionado = { celda: {x:col, y:fila}, tipo: celda.edificio.tipo, equipo: "jugador" };
                    unidadSeleccionada = null;
                } else {
                    unidadSeleccionada = null;
                    edificioSeleccionado = null;
                }
            }
        } else if (e.button === 2) { // Derecho: orden
            e.preventDefault();
            if (unidadSeleccionada) {
                unidadSeleccionada.irA(col, fila);
                // Si es aldeano y hay recurso, asignar recolecci√≥n
                if (unidadSeleccionada.tipo === "aldeano" && mapa[fila][col].recurso) {
                    unidadSeleccionada.objetivoRecurso = { x: col, y: fila };
                }
            }
        }
    });

    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    // Iniciar loop
    requestAnimationFrame(gameLoop);
</script>
</body>
</html>
